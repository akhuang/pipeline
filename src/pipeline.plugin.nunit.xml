<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <NUnitToolPath Condition=" '$(NUnitToolPath)' == '' ">$(MSBuildStartupDirectory)\lib\nunit\</NUnitToolPath>
    <NUnitConsoleTool-x86>$(NUnitToolPath)nunit-console-x86.exe</NUnitConsoleTool-x86>
    <NUnitConsoleTool>$(NUnitToolPath)nunit-console.exe</NUnitConsoleTool>
    <NUnitConsoleToolArgs>/nologo /noshadow /xml=</NUnitConsoleToolArgs>
  </PropertyGroup>

  <PropertyGroup>
    <CoreUnitTestDependsOn>
      $(CoreUnitTestDependsOn);
      RunUnitTest;
    </CoreUnitTestDependsOn>
  </PropertyGroup>
  <Target Name="CoreUnitTest" DependsOnTargets="$(CoreUnitTestDependsOn)">
    <Message Text="CoreUnitTest (pipeline.plugin.nunit)"/>
  </Target>

  <PropertyGroup>
    <CoreAcceptanceTestDependsOn>
      $(CoreAcceptanceTestDependsOn);
      RunIntegrationTest;
      RunAcceptanceTest;
    </CoreAcceptanceTestDependsOn>
  </PropertyGroup>
  <Target Name="CoreAcceptanceTest" DependsOnTargets="$(CoreAcceptanceTestDependsOn)">
    <Message Text="CoreAcceptanceTest (pipeline.plugin.nunit)"/>
  </Target>  

  <Target Name="RunUnitTest">
    <Message Text="RunUnitTest (pipeline.plugin.nunit)"/>

    <ItemGroup>
      <UnitTestAssemblies Include="$(MSBuildStartupDirectory)\**\bin\$(Configuration)\*UnitTests.dll"/>
    </ItemGroup>

    <Exec Command="&quot;$(NUnitConsoleTool)&quot; @(UnitTestAssemblies ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgs)&quot;$(MSBuildStartupDirectory)\unit-test-results.xml&quot;"
          Condition=" '@(UnitTestAssemblies)' != '' "/>

    <ItemGroup>
      <UnitTestAssemblies-x86 Include="$(MSBuildStartupDirectory)\**\bin\$(Configuration)\*UnitTests.x86.dll"/>
    </ItemGroup>

    <Exec Command="&quot;$(NUnitConsoleTool-x86)&quot; @(UnitTestAssemblies-x86 ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgs)&quot;$(MSBuildStartupDirectory)\unit-x86-test-results.xml&quot;"
          Condition=" '@(UnitTestAssemblies-x86)' != '' "/>

  </Target> 

  <Target Name="RunSmokeTest">
    <Message Text="RunSmokeTest (pipeline.plugin.nunit)"/>

    <ItemGroup>
      <SmokeTestAssemblies Include="$(ArtifactTestFolder)\*SmokeTests.dll"></SmokeTestAssemblies>
    </ItemGroup>

    <Exec Command="&quot;$(NUnitConsoleTool)&quot; @(SmokeTestAssemblies ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgs)&quot;$(MSBuildStartupDirectory)\smoke-test-results.xml&quot;" 
          Condition=" '@(SmokeTestAssemblies)' != '' "/>

  </Target>

  <Target Name="RunIntegrationTest">
    <Message Text="RunIntegrationTest (pipeline.plugin.nunit)"/>

    <ItemGroup>
      <IntegrationAcceptanceTestAssemblies Include="$(ArtifactTestFolder)\*IntegrationTests.dll"></IntegrationAcceptanceTestAssemblies>
    </ItemGroup>
    <Exec Command="$(NUnitConsoleTool) @(IntegrationAcceptanceTestAssemblies ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgsForAcceptanceTests)&quot;$(MSBuildStartupDirectory)\integration-test-results.xml&quot;"
          Condition=" '@(IntegrationAcceptanceTestAssemblies)' != '' "/>

    <ItemGroup>
      <IntegrationAcceptanceTestAssemblies-x86 Include="$(ArtifactTestFolder)\*IntegrationTests.x86.dll"></IntegrationAcceptanceTestAssemblies-x86>
    </ItemGroup>

    <Exec Command="$(NUnitConsoleTool-x86) @(IntegrationAcceptanceTestAssemblies-x86 ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgsForAcceptanceTests)&quot;$(MSBuildStartupDirectory)\integration-x86-test-results.xml&quot;" 
          Condition=" '@(IntegrationAcceptanceTestAssemblies-x86)' != '' "/>

  </Target>  

  <Target Name="RunAcceptanceTest">
    <Message Text="RunAcceptanceTest (pipeline.plugin.nunit)"/>

    <ItemGroup>
      <AcceptanceTestAssemblies Include="$(ArtifactTestFolder)\*AcceptanceTests.dll"></AcceptanceTestAssemblies>
    </ItemGroup>   
    <Exec Command="&quot;$(NUnitConsoleTool)&quot; @(AcceptanceTestAssemblies ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgsForAcceptanceTests)&quot;$(MSBuildStartupDirectory)\acceptance-test-results.xml&quot;" 
          Condition=" '@(AcceptanceTestAssemblies)' != '' "/>

    <ItemGroup>
      <AcceptanceTestAssemblies-x86 Include="$(ArtifactTestFolder)\*AcceptanceTests.x86.dll"></AcceptanceTestAssemblies-x86>
    </ItemGroup>
    <Exec Command="&quot;$(NUnitConsoleTool-x86)&quot; @(AcceptanceTestAssemblies-x86 ->'&quot;%(Identity)&quot;',' ') $(NUnitConsoleToolArgsForAcceptanceTests)&quot;$(MSBuildStartupDirectory)\acceptance-x86-test-results.xml&quot;"
          Condition=" '@(AcceptanceTestAssemblies-x86)' != '' "/>

  </Target>  
  
</Project>